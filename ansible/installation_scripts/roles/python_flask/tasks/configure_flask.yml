---
- name: Stopping the emission_app service
  service:
    name: gunicorn
    enabled: yes
    state: stopped
  tags: update

- name: Making sure emission_app directory is present
  file:
    path: "{{ base_dir }}/cqube/emission_app"
    recurse: yes
    state: directory
  tags: install

- name: Creating environmental variables
  file:
    path: "{{ base_dir }}/cqube/emission_app/python/env.py"
    state: touch
    mode: u+rw,g+rw,o+rw
  tags: install

- name: create a virtual environment directory
  file:
    path: "{{ base_dir }}/cqube/emission_app/flaskenv"
    state: directory
  tags: install

- name: Install requirements
  become: yes
  pip:
    requirements: "{{ base_dir }}/cqube/emission_app/requirements.txt"
    virtualenv: "{{ base_dir }}/cqube/emission_app/flaskenv"
    virtualenv_python: /usr/bin/python3
  tags: [ install, update ]

- name: Manually create the initial virtualenv
  command:
    cmd: virtualenv {{ base_dir }}/cqube/emission_app/flaskenv -p python3
    creates: "{{ base_dir }}/cqube/emission_app/flaskenv"
  tags: install

- name: Copy requirements.txt
  copy:
    src: requirements.txt
    dest: "{{ base_dir }}/cqube/emission_app/requirements.txt"
  tags: [ install, update ]

- name: Copying python files
  shell: cp -R ../../development/python {{ base_dir }}/cqube/emission_app/    
  tags: [ install, update ]

- name: Delete env.py
  file:
    path: "{{ base_dir }}/cqube/emission_app/python/env.py"
    state: absent
  tags: update

- name: Updating env.py
  template:
    src: env.py.j2
    dest: "{{ base_dir }}/cqube/emission_app/python/env.py"
  tags: [ install, update ]   

- name: Changing the permission of the directory
  file:
    path: "{{ base_dir }}/cqube/emission_app"
    owner: "{{ system_user_name }}"
    group: "{{ system_user_name }}"
    recurse: yes
  tags: install
